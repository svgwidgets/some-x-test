/**
 * Digital I/O Component
 * 
 * Represents binary/discrete values (true/false, on/off, open/closed).
 * Used for components like valves, motors, switches, relays, etc.
 */

import { BaseIOComponent, IOComponent, IOMetadata } from './IOComponent';

export interface DigitalStateMapping {
  /** Label when value is true (e.g., "Open", "On", "Running") */
  true: string;
  
  /** Label when value is false (e.g., "Closed", "Off", "Stopped") */
  false: string;
  
  /** Optional intermediate states */
  transitioning?: string;
  fault?: string;
}

export interface DigitalIO extends IOComponent<boolean> {
  ioType: 'digital';
  
  /** State labels for display */
  states: DigitalStateMapping;
  
  /** Optional: Is this output controllable? */
  controllable?: boolean;
  
  /** Optional: Current transition state */
  transitioning?: boolean;
}

/**
 * Digital I/O implementation
 */
export class DigitalIOComponent extends BaseIOComponent<boolean> implements DigitalIO {
  ioType: 'digital' as const;
  states: DigitalStateMapping;
  controllable: boolean;
  transitioning: boolean;
  
  constructor(config: {
    id: string;
    channel: string;
    value: boolean;
    states: DigitalStateMapping;
    controllable?: boolean;
    description?: string;
  }) {
    super({
      id: config.id,
      channel: config.channel,
      value: config.value,
      ioType: 'digital',
      description: config.description,
    });
    
    this.states = config.states;
    this.controllable = config.controllable ?? false;
    this.transitioning = false;
  }
  
  /**
   * Get current state label
   */
  getStateLabel(): string {
    if (this.transitioning && this.states.transitioning) {
      return this.states.transitioning;
    }
    return this.value ? this.states.true : this.states.false;
  }
  
  /**
   * Toggle the value (if controllable)
   */
  toggle(): void {
    if (!this.controllable) {
      throw new Error(`Digital I/O ${this.id} is not controllable`);
    }
    this.updateValue(!this.value);
  }
  
  /**
   * Set to true state
   */
  setTrue(): void {
    if (!this.controllable) {
      throw new Error(`Digital I/O ${this.id} is not controllable`);
    }
    this.updateValue(true);
  }
  
  /**
   * Set to false state
   */
  setFalse(): void {
    if (!this.controllable) {
      throw new Error(`Digital I/O ${this.id} is not controllable`);
    }
    this.updateValue(false);
  }
  
  /**
   * Start transition animation
   */
  startTransition(): void {
    this.transitioning = true;
  }
  
  /**
   * End transition animation
   */
  endTransition(): void {
    this.transitioning = false;
  }
}

/**
 * Factory function for creating digital I/O
 */
export function createDigitalIO(config: {
  id: string;
  channel: string;
  initialValue?: boolean;
  states: DigitalStateMapping;
  controllable?: boolean;
  description?: string;
}): DigitalIO {
  return new DigitalIOComponent({
    ...config,
    value: config.initialValue ?? false,
  });
}

/**
 * Common digital I/O presets
 */
export const DIGITAL_IO_PRESETS = {
  valve: {
    states: { true: 'Open', false: 'Closed', transitioning: 'Moving' },
    controllable: true,
  },
  pump: {
    states: { true: 'Running', false: 'Stopped', transitioning: 'Starting' },
    controllable: true,
  },
  motor: {
    states: { true: 'On', false: 'Off', transitioning: 'Starting' },
    controllable: true,
  },
  switch: {
    states: { true: 'On', false: 'Off' },
    controllable: true,
  },
  alarm: {
    states: { true: 'Active', false: 'Normal' },
    controllable: false,
  },
  indicator: {
    states: { true: 'On', false: 'Off' },
    controllable: false,
  },
};
