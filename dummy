<template>
  <g>
    <!-- Tank outline -->
    <path
      :d="elements.outline.d"
      fill="none"
      stroke="#333"
      stroke-width="2"
      class="tank-outline"
    />
    
    <!-- Clip path definition -->
    <defs>
      <clipPath :id="`${clipPathId}-${io.id}`">
        <path :d="elements.outline.d" />
      </clipPath>
    </defs>
    
    <!-- Liquid (animated by AnimationController) -->
    <rect
      class="tank-liquid"
      :x="elements.liquid.x"
      :y="liquidY"
      :width="elements.liquid.width"
      :height="liquidHeight"
      :fill="liquidColor"
      opacity="0.8"
      :clip-path="`url(#${clipPathId}-${io.id})`"
    />
    
    <!-- Value display -->
    <text 
      v-if="showValue"
      :x="valueDisplay.x" 
      :y="valueDisplay.y" 
      text-anchor="middle" 
      font-size="16" 
      font-weight="bold" 
      :fill="textColor"
    >
      {{ Math.round(io.value) }}%
    </text>
    
    <!-- Ports -->
    <g v-if="showPorts">
      <circle 
        v-for="port in visual.ports"
        :key="port.id"
        :cx="port.position.x" 
        :cy="port.position.y" 
        r="4" 
        :fill="port.type === 'inlet' ? '#2196F3' : '#FF9800'" 
        stroke="#333" 
        stroke-width="1.5"
      />
    </g>
    
    <!-- Label -->
    <text 
      v-if="showLabel"
      :x="centerX" 
      y="-8" 
      text-anchor="middle" 
      font-size="10" 
      font-weight="bold" 
      fill="#333"
    >
      {{ io.id }}
    </text>
  </g>
</template>

<script setup lang="ts">
import { computed } from 'vue';
import type { AnalogIO } from '../../io';
import { svgLibrary, getIOColor } from '../../visuals';

interface Props {
  io: AnalogIO;
  showPorts?: boolean;
  showLabel?: boolean;
  showValue?: boolean;
}

const props = withDefaults(defineProps<Props>(), {
  showPorts: true,
  showLabel: true,
  showValue: true,
});

const visual = computed(() => svgLibrary.get('vertical-tank')!);
const elements = computed(() => visual.value.metadata?.elements || {});
const liquidRange = computed(() => visual.value.metadata?.liquidRange || { top: 15, bottom: 105 });
const valueDisplay = computed(() => visual.value.metadata?.valueDisplay || { x: 25, y: 65 });
const clipPathId = computed(() => visual.value.metadata?.clipPathId || 'tank-clip-path');
const centerX = computed(() => visual.value.viewBox.width / 2);

const fillableHeight = computed(() => liquidRange.value.bottom - liquidRange.value.top);
const liquidHeight = computed(() => (props.io.value / 100) * fillableHeight.value);
const liquidY = computed(() => liquidRange.value.bottom - liquidHeight.value);

const liquidColor = computed(() => getIOColor(props.io));
const textColor = computed(() => props.io.value > 50 ? '#FFFFFF' : '#333');
</script>

<style scoped>
.tank-liquid {
  transition: y 0.5s ease-out, height 0.5s ease-out;
}
</style>
