<template>
  <g
    :ref="(el) => setComponentRef(el as SVGGElement)"
    class="animated-component"
  >
    <slot></slot>
  </g>
</template>

<script setup lang="ts">
import { ref, watch, onMounted, onUnmounted, nextTick } from 'vue';
import type { IOComponent } from '../io/IOComponent';
import type { AnimationDefinition } from './AnimationDefinition';
import { animationController } from './AnimationController';

interface Props {
  io: IOComponent;
  animations: AnimationDefinition[];
}

const props = defineProps<Props>();

const componentRef = ref<SVGGElement | null>(null);

function setComponentRef(el: SVGGElement | null) {
  componentRef.value = el;
  if (el) {
    nextTick(() => {
      applyAnimations();
    });
  }
}

// Watch I/O value changes
watch(() => props.io.value, () => {
  nextTick(() => {
    applyAnimations();
  });
}, { deep: true });

// Watch animation array changes
watch(() => props.animations, () => {
  nextTick(() => {
    applyAnimations();
  });
}, { deep: true });

// IMPORTANT: Watch animation array length changes (when animations are added/removed)
watch(() => props.animations.length, () => {
  nextTick(() => {
    applyAnimations();
  });
});

function applyAnimations() {
  if (!componentRef.value) {
    console.warn('[AnimatedComponent] No component ref');
    return;
  }
  
  // Apply each animation
  props.animations.forEach(animation => {
    const targetElement = componentRef.value!.querySelector(animation.target);
    
    if (targetElement) {
      animationController.applyAnimation(
        targetElement as SVGElement,
        animation,
        props.io
      );
    } else {
      console.warn(`[AnimatedComponent] Target element not found: ${animation.target} in component ${props.io.id}`);
    }
  });
  
  // If no animations, make sure to stop any running ones
  if (props.animations.length === 0) {
    // Find all potentially animated elements and stop them
    const animatableSelectors = ['.pump-impeller', '.tank-liquid', '.flow-dot'];
    animatableSelectors.forEach(selector => {
      const element = componentRef.value!.querySelector(selector);
      if (element && element instanceof SVGElement) {
        element.style.animation = '';
      }
    });
  }
}

onMounted(() => {
  nextTick(() => {
    applyAnimations();
  });
});

onUnmounted(() => {
  // Cleanup animations
  if (componentRef.value) {
    const animatableSelectors = ['.pump-impeller', '.tank-liquid', '.flow-dot'];
    animatableSelectors.forEach(selector => {
      const element = componentRef.value!.querySelector(selector);
      if (element && element instanceof SVGElement) {
        element.style.animation = '';
      }
    });
  }
});
</script>

<style scoped>
.animated-component {
  /* Base styles */
}
</style>
